suite: test ingress and target group binding
templates:
  - ingress.yaml
  - targetGroupBinding.yaml
tests:
  - it: should not create ingress when create is false
    template: ingress.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      ingress:
        create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create ingress with ALB configuration
    template: ingress.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      ingress:
        create: true
        className: alb
        groupName: interop-be
        hosts:
          - host: api.example.com
            paths:
              - path: /
                pathType: Prefix
      service:
        portName: http
        containerPort: 8080
    asserts:
      - isKind:
          of: Ingress
      - equal:
          path: metadata.name
          value: test-service
      - equal:
          path: metadata.namespace
          value: test-namespace
      - equal:
          path: spec.ingressClassName
          value: alb

  - it: should have default ALB annotations
    template: ingress.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      ingress:
        create: true
        groupName: interop-be
        applicationPath: /api
      service:
        portName: http
        containerPort: 8080
    asserts:
      - equal:
          path: metadata.annotations["alb.ingress.kubernetes.io/scheme"]
          value: internal
      - equal:
          path: metadata.annotations["alb.ingress.kubernetes.io/target-type"]
          value: ip

  - it: should configure ingress rules with applicationPath
    template: ingress.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      ingress:
        create: true
        groupName: interop-be
        applicationPath: /api
        host: api.example.com
      service:
        portName: http
        containerPort: 8080
    asserts:
      - equal:
          path: spec.rules[0].host
          value: api.example.com
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /api
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: Prefix

  - it: should not create target group binding when targetGroupArn not provided
    template: targetGroupBinding.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      service:
        create: true
        portName: http
    asserts:
      - hasDocuments:
          count: 0

  - it: should create target group binding with ARN
    template: targetGroupBinding.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      service:
        create: true
        portName: http
        targetGroupArn: "arn:aws:elasticloadbalancing:eu-central-1:123456789012:targetgroup/test-tg/abc123"
        containerPort: 8080
    asserts:
      - isKind:
          of: TargetGroupBinding
      - equal:
          path: metadata.name
          value: test-service
      - equal:
          path: metadata.namespace
          value: test-namespace
      - equal:
          path: spec.targetGroupARN
          value: "arn:aws:elasticloadbalancing:eu-central-1:123456789012:targetgroup/test-tg/abc123"

  - it: should configure target group binding with IP target type
    template: targetGroupBinding.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      service:
        create: true
        portName: http
        targetGroupArn: "arn:aws:elasticloadbalancing:eu-central-1:123456789012:targetgroup/test-tg/abc123"
        targetType: ip
        containerPort: 8080
    asserts:
      - equal:
          path: spec.targetType
          value: ip

  - it: should configure target group binding with instance target type
    template: targetGroupBinding.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      service:
        create: true
        portName: http
        targetGroupArn: "arn:aws:elasticloadbalancing:eu-central-1:123456789012:targetgroup/test-tg/abc123"
        targetType: instance
        containerPort: 8080
    asserts:
      - equal:
          path: spec.targetType
          value: instance

  - it: should configure healthcheck in target group binding
    template: targetGroupBinding.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      service:
        create: true
        portName: http
        targetGroupArn: "arn:aws:elasticloadbalancing:eu-central-1:123456789012:targetgroup/test-tg/abc123"
        containerPort: 8080
        albHealthcheck:
          path: /health
          port: "8080"
          protocol: HTTP
          successCodes: "200"
    asserts:
      - isKind:
          of: TargetGroupBinding

  - it: should set ipAddressType when specified
    template: targetGroupBinding.yaml
    set:
      techStack: nodejs
      name: test-service
      namespace: test-namespace
      service:
        create: true
        portName: http
        targetGroupArn: "arn:aws:elasticloadbalancing:eu-central-1:123456789012:targetgroup/test-tg/abc123"
        ipAddressType: ipv4
        containerPort: 8080
    asserts:
      - equal:
          path: spec.ipAddressType
          value: ipv4
